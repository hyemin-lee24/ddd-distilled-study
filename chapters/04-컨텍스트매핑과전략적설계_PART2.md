# 04. 컨텍스트 매핑과 전략적 설계

## 이 장의 구성

1. 매핑의 종류
2. 컨텍스트 매핑 활용하기
3. 컨텍스트 매핑 사례

※ 이 장에서는 **"2. 컨텍스트 매핑 활용하기, 3. 컨텍스트 매핑 사례"**를 정리한 내용입니다.



## 컨텍스트 매핑 활용하기

바운디드 컨텍스트와 통합할 때 어떤 종류의 인터페이스를 제공받을 수 있는지는 해당 바운디드 컨텍스트를 소유한 팀에 달려있다.

SOAP을 이용한 RPC, RESTful 인터페이스와 리소스들, 혹은 큐나 발행-구독 모델을 사용하는 인터페이스 메시징일 수도 있다.
나쁜 경우에는 데이터베이스나 파일 시스템 통합을 강요받을 수 있는데, 그런 경우 반드시 반부패 계층을 사용하여 모델을 독립시켜야 한다.

------

### SOAP을 이용한 RPC

- 원격 프로시저 호출인 RPC 사용 방법 중 잘 알려진 것이 SOAP을 이용하는 방식이다.
- 다른 시스템이 서비스를 사용할 때 마치 로컬 프로시저나 메서드를 호출하는 것처럼 사용한다는 개념이다.
- SOAP은 네트워크상의 요청, 원격 시스템에 요청 전달, 성공적 수행, 네트워크를 통한 결과 반환을 보장해야 한다.
- 하지만 처음 통합을 수행할 때 예기치 못한 네트워크 장애나 지연 가능성이 있다.
- 클라이언트 바운디드 컨텍스트와 서비스를 제공하는 바운디드 컨텍스트 사이의 **강한 결합**을 암시한다.
- 단점은 견고함이 떨어진다는 점인데, 네트워크나 SOAP API를 호스팅하는 시스템에 문제가 생기면 에러 결과만 받고 실패하게 된다.
- 원치 않는 외부 영향으로부터 클라이언트 바운디드 컨텍스트를 분리할 필요가 있다면 **반부패 계층을 정의해야 한다**.

------

### RESTful HTTP

- 바운디드 컨텍스트 간에 교환되는 리소스뿐만 아니라 POST, GET, PUT, DELETE 네 가지 주요 오퍼레이션이 관여된다.
- REST 인터페이스를 제공하는 서비스 바운디드 컨텍스트는 **공개 호스트 서비스**와 **공표된 언어**를 제공해야 한다.
- 공표된 언어로 리소스를 정의하고 REST URI로 구성하면 온전한 공개 호스트 서비스를 구성할 수 있다.

#### 흔한 실수

- 도메인 모델 안에 직접적으로 애그리게잇을 반영하는 리소스를 설계하는 것
   → 모든 클라이언트에게 **준수자 관계**를 강요하게 되어, 모델 변화가 리소스 형태에 영향을 주게 된다.
- 리소스는 **클라이언트 주도의 유스케이스를 지원**할 수 있도록,
   클라이언트가 원하는 구성과 형태를 갖추도록 고려해야 한다.

------

### 메시징

- **분절된 형태와의 일시적인 결합을 대부분 제거**할 수 있다.
- 즉각적인 결과가 필수적이지 않을 경우, 메시징을 이용해 견고한 시스템을 구축하는 것이 좋다.

#### REST를 사용해 비동기하기

- 점차 증가하는 리소스에 대해 REST 기반으로 폴링하는 방식으로 **비동기 메시징 구현 가능**
- 백그라운드 프로세싱을 사용하여, 도메인 이벤트를 제공하는 **아톰 피드 리소스**를 지속적으로 폴링할 수 있다.

------

바운디드 컨텍스트 내의 애그리게잇이 도메인 이벤트를 만들면,관심 있는 다른 컨텍스트들이 발생된 이벤트를 사용한다.
이벤트를 소비하는 바운디드 컨텍스트에서는 **새로운 애그리게잇을 생성**하거나 **기존 애그리게잇을 수정**해야 할 수도 있다.

통합에 메시징을 사용하는 경우, 전체 솔루션의 품질은 사용한 **메시징 메커니즘의 품질에 크게 좌우**된다.
메시징 메커니즘은 최소한 **한 번 이상 전달**(메시지를 주기적으로 재전달하는 메시징 패턴)을 보장해야 한다.

- 메시지가 **한 번 이상 전달**될 수 있기 때문에, 수신자는 이 상황을 **정상적으로 처리할 수 있도록 설계**해야 한다.
- **멱등 수신자(idempotent receiver)**는 오퍼레이션이 여러 번 수행되더라도 동일한 결과가 되도록 만드는 방식이다.

메시징 메커니즘은 항상 **비동기 요청-응답 통신**을 사용하므로,**일정 수준의 지연은 자연스럽게 발생**한다.
이러한 지연을 감내할 수 있다면, **메시징으로 시스템을 설계하는 것이 좋다**.



## 컨텍스트 매핑 사례

### 사례: 서로 다른 3개의 바운디드 컨텍스트에 각 1개의 정책 존재

- 계약 심사 컨텍스트
- 검사 컨텍스트
- 청구 컨텍스트

------

### 정책 발행 흐름

1. **계약 심사 컨텍스트**에서 정책 컴포넌트가 생성되면,
    → **“정책 발행”**이라는 이름의 **도메인 이벤트**를 발생시킬 수 있음.
2. 이 도메인 이벤트는 **메시징 구독**을 통해
    **검사 컨텍스트** 및 **청구 컨텍스트** 등 다른 바운디드 컨텍스트로 전달됨.
3. 구독한 바운디드 컨텍스트들은 해당 이벤트에 반응하여,
    각자의 내부에 **상응하는 정책 컴포넌트**를 생성할 수 있음.

------

### 식별성과 추적

- 정책 발행 도메인 이벤트는 **정책 ID**를 담고 있어,
   이를 통해 정책을 식별함.
- **구독 바운디드 컨텍스트**에서 생성된 모든 컴포넌트는
   발신 주체인 **계약 심사 컨텍스트**를 역추적하기 위해
   해당 정책 ID를 보유함.
- 이후, 구독 바운디드 컨텍스트는 이 **정책 발행 ID**를 사용해
   계약 심사 컨텍스트로 **쿼리를 수행**할 수 있음.

------

### 통합 방식 선택 기준

- **자율성이 핵심 요구사항**이라면:
   → 도메인 이벤트에 **충분한 데이터를 모두 포함**시키는 방식 사용
- **높은 보안 수준 등으로 인해 전체 데이터 노출이 어려울 경우**:
   → **가벼운 도메인 이벤트 + 계약 심사 컨텍스트에 쿼리 재요청** 방식 사용

------

### 쿼리 재요청 방식

- **계약 심사 컨텍스트**에서
   **RESTful 공개 호스트 서비스** 및 **공표된 언어**를 설계함.
- 구독 측 컨텍스트는
   → `HTTP GET` + 정책 발행 ID를 이용해
   정책 발행 데이터를 검색할 수 있음.